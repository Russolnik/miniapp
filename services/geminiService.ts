import { GoogleGenAI, Modality } from "@google/genai";
import { AspectRatio } from "../types";

export type ModelType = 'imagen-4.0-generate-001' | 'gemini-2.5-flash-image';

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º AspectRatio –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
export type { AspectRatio };

const dataUrlToInlineData = (dataUrl: string) => {
    const [header, base64Data] = dataUrl.split(',');
    if (!header || !base64Data) {
        throw new Error("Invalid data URL format");
    }
    const mimeTypeMatch = header.match(/:(.*?);/);
    if (!mimeTypeMatch || !mimeTypeMatch[1]) {
        throw new Error("Could not extract MIME type from data URL");
    }
    const mimeType = mimeTypeMatch[1];
    return {
        inlineData: {
            data: base64Data,
            mimeType,
        },
    };
};

export const generateImage = async (
    apiKey: string,
    prompt: string, 
    aspectRatio: AspectRatio, 
    model: ModelType, 
    referenceImages: string[] // base64 data URLs
): Promise<string[]> => {
  try {
    if (!apiKey) {
      throw new Error("API –∫–ª—é—á –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω");
    }
    const ai = new GoogleGenAI({ apiKey });
    
    if (model === 'imagen-4.0-generate-001') {
        const response = await ai.models.generateImages({
            model: 'imagen-4.0-generate-001',
            prompt: prompt,
            config: {
                numberOfImages: 1,
                outputMimeType: 'image/png',
                aspectRatio: aspectRatio,
            },
        });

        if (response.generatedImages && response.generatedImages.length > 0) {
            return response.generatedImages
                .filter(img => img?.image?.imageBytes)
                .map(img => `data:image/png;base64,${img.image!.imageBytes}`);
        } else {
            throw new Error("No images were generated by Imagen 4.");
        }
    } else if (model === 'gemini-2.5-flash-image') {
        const parts: any[] = [];
        
        if (referenceImages.length > 0) {
            parts.push(...referenceImages.map(dataUrlToInlineData));
        }
        
        if (prompt.trim()) {
             parts.push({ text: prompt });
        }

        if (parts.length === 0) {
            throw new Error("A prompt or at least one reference image is required for Gemini Flash.");
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å –∏–∑ gemini-image-chat
        // –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏
        const modelsToTry = [
            'gemini-2.5-flash-image',
            'gemini-1.5-flash',
            'gemini-1.5-pro'
        ];
        
        let lastError: Error | null = null;
        
        for (const modelName of modelsToTry) {
            try {
                console.log(`üîÑ –ü—Ä–æ–±—É—é –º–æ–¥–µ–ª—å: ${modelName}`);
                const response = await ai.models.generateContent({
                    model: modelName,
                    contents: { parts },
                    config: {
                        responseModalities: [Modality.IMAGE],
                    },
                });

                const generated: string[] = [];
                if (response.candidates && response.candidates.length > 0) {
                    const candidate = response.candidates[0];
                    if (candidate?.content?.parts) {
                        for (const part of candidate.content.parts) {
                            if (part.inlineData && part.inlineData.data && part.inlineData.mimeType) {
                                const base64ImageBytes: string = part.inlineData.data;
                                const mimeType: string = part.inlineData.mimeType;
                                generated.push(`data:${mimeType};base64,${base64ImageBytes}`);
                            }
                        }
                    }
                }

                if (generated.length > 0) {
                    console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –º–æ–¥–µ–ª—å—é: ${modelName}`);
                    return generated;
                } else {
                    throw new Error(`–ú–æ–¥–µ–ª—å ${modelName} –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.`);
                }
            } catch (err: any) {
                lastError = err;
                console.warn(`‚ö†Ô∏è –ú–æ–¥–µ–ª—å ${modelName} –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞:`, err.message);
                
                // –ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞ –∫–≤–æ—Ç—ã –∏–ª–∏ –¥–æ—Å—Ç—É–ø–∞, –Ω–µ –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏
                if (err.message?.includes('quota') || 
                    err.message?.includes('429') ||
                    err.message?.includes('billed') ||
                    err.message?.includes('INVALID_ARGUMENT')) {
                    break;
                }
            }
        }
        
        // –ï—Å–ª–∏ –≤—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—à–∏–±–∫—É
        if (lastError) {
            throw lastError;
        }
        
        throw new Error("No images were generated by Gemini Flash.");
    } else {
        throw new Error(`Unsupported model: ${model}`);
    }
  } catch (error: any) {
    console.error("Error generating image:", error);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫
    if (error?.message) {
      const errorMsg = error.message.toLowerCase();
      
      // –û—à–∏–±–∫–∞ –∫–≤–æ—Ç—ã
      if (errorMsg.includes('quota') || errorMsg.includes('429') || error?.error?.code === 429) {
        const retryAfter = error?.error?.details?.find((d: any) => d['@type']?.includes('RetryInfo'))?.retryDelay || '';
        throw new Error(`–ü—Ä–µ–≤—ã—à–µ–Ω–∞ –∫–≤–æ—Ç–∞ API. ${retryAfter ? `–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ ${retryAfter}` : '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.'}`);
      }
      
      // Imagen —Ç—Ä–µ–±—É–µ—Ç –±–∏–ª–ª–∏–Ω–≥–∞
      if (errorMsg.includes('billed') || errorMsg.includes('only accessible to billed')) {
        throw new Error('Imagen 4 –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Google Cloud. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–¥–µ–ª—å "Gemini Flash Image".');
      }
      
      // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
      if (error instanceof Error) {
        throw new Error(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${error.message}`);
      }
    }
    
    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –ø–æ–∑–∂–µ.");
  }
};

